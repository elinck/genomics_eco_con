<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>reads – BIOE591: Genomics for Ecology &amp; Conservation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ff63373b1067ca6f91cf1456aa1f00a2.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">BIOE591: Genomics for Ecology &amp; Conservation</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="understanding-.fastq-data-and-short-read-quality-control" class="level1">
<h1>Understanding <code>.fastq</code> Data and Short Read Quality Control</h1>
<p>Our <a href="./hpc.html">introduction to the Tempest HPC</a> included our first exposure to real live short read sequencing data. I will assume that this week’s reading and discussion has everyone feeling a little more comfortable with how these data are generated and what a read is in the first place. Today’s lab, which is somewhat shorter than its predecessors, will cover the basics of <code>.fastq</code> data: its format, what aspects of a sample and its preparation are contained in reads, and how to trim and filter reads to ensure that only high-quality data get passed on to the next stage of your workflow.</p>
<section id="example-data" class="level2">
<h2 class="anchored" data-anchor-id="example-data">Example Data</h2>
<p>The remaining classes before spring break will lead us through an abbreviated sequence alignment, variant calling, and variant filtering pipeline. These basic bioinformatic processing steps are required for nearly all population-level genomics and transcriptomics projects; while the exact programs and filtering choices will vary, the backbone presented here should orient you to successfully preparing your own data for subsequent analysis. To achieve this goal, we will work with unpublished exon capture data from 13 species of high Andean tanagers (Passeriformes: Thraupidae). These data were generated by exon capture—a kind of reduced representation library preparation method that targets specific expressed genes by enriches them with synthetic user-designed probes—of the seven hemoglobin peptide chains, or subunits. Because hemoglobin structure impacts its ability to bind and transport <span class="math inline">\(O_2\)</span> in the blood, variation in underlying sequences may be associated with adaptations to high or low altitude and attendant difference in the partial pressure of oxygen (<span class="math inline">\(PO_2\)</span>).</p>
<p>Below is a complete list of species with linked natural history and distributional data. Feel free to pick your favorite, but note that sample sizes vary, posing a trade-off between the time needed to run tools and how interesting the data ultimately is. All can be found in named subdirectories within <code>bioe-591-genomics/course-materials/data/raw_reads/</code>.</p>
<ul>
<li><a href="https://birdsoftheworld.org/bow/species/giacon1/cur/introduction">Giant Conebill <em>Oreomanes fraseri</em></a> (outdated binomial used here)</li>
<li><a href="https://birdsoftheworld.org/bow/species/capcon1/cur/introduction">Capped Conebill <em>Conirostrum albifrons</em></a></li>
<li><a href="https://birdsoftheworld.org/bow/species/cincon1/cur/introduction">Cinereous Conebill <em>Conirostrum cinereum</em></a></li>
<li><a href="https://birdsoftheworld.org/bow/species/blbcon1/cur/introduction">Blue-backed Conebill <em>Conirostrum sitticolor</em></a></li>
<li><a href="https://birdsoftheworld.org/bow/species/whsflo1/cur/introduction">White-sided Flowerpiercer <em>Diglossa albilatera</em></a></li>
<li><a href="https://birdsoftheworld.org/bow/species/cibflo1/cur/introduction">Cinnamon-bellied Flowerpiercer <em>Diglossa baritula</em></a></li>
<li><a href="https://birdsoftheworld.org/bow/species/bktflo1/cur/introduction">Black-throated Flowerpiercer <em>Diglossa brunneiventris</em></a></li>
<li><a href="https://birdsoftheworld.org/bow/species/bluflo1/cur/introduction">Blueish Flowerpiercer <em>Diglossa caerulescens</em></a></li>
<li><a href="https://birdsoftheworld.org/bow/species/masflo1/cur/introduction">Masked Flowerpiercer <em>Diglossa cyanea</em></a></li>
<li><a href="https://birdsoftheworld.org/bow/species/debflo1/cur/introduction">Deep-blue Flowerpiercer <em>Diglossa glauca</em></a></li>
<li><a href="https://birdsoftheworld.org/bow/species/gloflo1/cur/introduction">Glossy Flowerpiercer <em>Diglossa lafresnayii</em></a></li>
<li><a href="https://birdsoftheworld.org/bow/species/mouflo1/cur/introduction">Moustached Flowerpiercer <em>Diglossa mystacalis</em></a></li>
<li><a href="https://birdsoftheworld.org/bow/species/rusflo1/cur/introduction">Rusty Flowerpiercer <em>Diglossa sittoides</em></a></li>
</ul>
</section>
<section id="the-.fastq-format" class="level2">
<h2 class="anchored" data-anchor-id="the-.fastq-format">The <code>.fastq</code> Format</h2>
<p>Sequencing reads are turned into plain-text data as <code>.fastq</code> files, which are then typically compressed using <code>gzip</code> into compressed <code>.fast.gz</code> files. Typing <code>gunzip filename.fastq.gz</code> will decompress the target, albeit slowly; because most tools can read compressed data and even small genomic datasets can be prohibitively large in their raw form, there is usually little reason to do this. However, it can be useful to look at least part of a human-readable <code>.fastq</code>. Luckily, we can do so using a version of the familiar <code>bash</code> command <code>cat</code> that works on compressed data (<code>zcat</code>). We’ll pipe this to <code>head</code> to avoid printing the entire contents of the file to your screen; if you’d like to expand beyond ten lines, use <code>head</code>’s <code>-n &lt;integer&gt;</code> argument.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">zcat</span> intro/catamenia_analis.fastq.gz <span class="kw">|</span> <span class="fu">head</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The output of this command should look something like this:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">@J00138:88:HG7TGBBXX:3:1101:1083:1086</span> 1:N:0:NGCGGAAT+NATGTTCC</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">NTCAAAGTCCAGCCCAGACCTCTCACCTTGCAGACAACTCCTTCCCCAACACGGCCCCCCACACCCCGCCCCCCCCAACCCCCCCCCAAACCCCCCAACAGCCCCCCCCGGCCCCCCCCTGCTCCCGCCCCCCCCCCCCGGCTCCCCCCCC</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&lt;AAFJFAFFJ77JJ&lt;JJJJJJJ&lt;JJJJJJJ7J7AJ7JJJJAF&lt;FAA--F-7--7-AAJ----777-7A-7FJA----777JJ----7--7-AJF-------7-7AA----7-FF7A77-----------A-A)-A)-)))))))-A---)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">@J00138:88:HG7TGBBXX:3:1101:7415:1086</span> 1:N:0:NGCGGAAT+NATGTTCC</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="ex">NTCAGGGCATGGGCAAATGCATAGACTGGCACAGACCCTCCCCAGAACTGGGAATTCAGGGCACGGGCAAATGCACAGACTGGCACAGACCCTCCCCAGAACTGGGAATTCAGGGCATGGGCAAATGCACAGACTGGCACAGACCCTCCCC</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#AAAFFAJJJJJJJFJJJJJJJJJJJJJFFJJJJJJJJFJJJJJJJJJJJJJJJJJJJJJFAJJJAJJJJJJFJJFJFJJJJJJJFJA&lt;JAJJJJJJJJFJJJJJFJFFJFJJFJF-AFFJAFJFFJJJA-&lt;AFJ-FAFFJJA7-)&lt;A&lt;AJ</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="ex">@J00138:88:HG7TGBBXX:3:1101:8958:1086</span> 1:N:0:NGCGGAAT+NATGTTCC</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="ex">NGTGAGCGAGCAACAGCGCCAGAGGGCAGACAGGATGGAAGAGCGCAAGAACAGAGCCTGGGGAGTGCGGAGACGCCGGCAGGCAGTTCACTTCCCATGCTCTTTCTTCTCCTGTGTGTCGTGACAGCAGCAGCAGCAGCAGCAGCAGCAG</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Though initially overwhelming, you will notice that the characters above consist of only four lines, which can be interpreted as follows:</p>
<ol type="1">
<li>a unique sequence identifier;</li>
<li>the nucleotide sequence itself;</li>
<li>a quality score identifier line (simply a <code>+</code>)</li>
<li>a quality score, encoded by an <code>ASCII</code> character.</li>
</ol>
<p>The sequence identifier, which is initially cryptic, follows the format below. Note that these are technical details about sequencing itself, and largely not the biology of the sample.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">@</span><span class="op">&lt;</span>instrument<span class="op">&gt;</span>:<span class="op">&lt;</span>run number<span class="op">&gt;</span>:<span class="op">&lt;</span>flowcell ID<span class="op">&gt;</span>:<span class="op">&lt;</span>lane<span class="op">&gt;</span>:<span class="op">&lt;</span>tile<span class="op">&gt;</span>:<span class="op">&lt;</span>x-pos<span class="op">&gt;</span>:<span class="op">&lt;</span>y-pos<span class="op">&gt;</span> <span class="op">&lt;</span>read<span class="op">&gt;</span>:<span class="op">&lt;</span>is filtered<span class="op">&gt;</span>:<span class="op">&lt;</span>control number<span class="op">&gt;</span>:<span class="op">&lt;</span>sample number<span class="op">&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The nucleotide sequence itself should be self explanatory, though note that <code>N</code> (and sometimes other )</p>
<p>(Illumina <a href="https://help.basespace.illumina.com/files-used-by-basespace/fastq-files">has a helpful explainer</a> on exactly what each character preceding the sequence data means.)</p>
<p>In your own subdirectory, dig up the <code>size.txt</code> file you generated during last week’s activity:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">reads</span>   bases</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">5417329</span> 818016679</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Here, the <code>reads</code> column is equvalent to the number of unique entries in the <code>.fastq</code>, i.e.&nbsp;every four-line set beginning with <code>@</code>. Notice too that dividing the number of bases by the number of reads produces a round number (<code>5417329 / 818016679</code>)—151. This means that the length of each Illumina sequencing read in the file is 151 bases, or more precisely, 150 with an extra base appended due to the chemistry of the sequencer. 150 bases is a standard read length for modern genomics, though 50-base and 100-base reads are also common, particularly when using older sequencing platform.</p>
<p>We now need to turn to a different source of data, as the simplicity of the standalone <code>catamenia_analis.fastq.gz</code> file elides something important—that <code>.fastq</code> reads often come as “paired-end reads”, or two sequencing reads of the same DNA fragment from opposite directions. Because we know the distribution of the size of fragments, paired-end (PE) reads give us constraints to work with during assembly. For example, a given read pair should map to the same chromosome and will likely be within a standard deviation or two of the mean insert size apart. This can be useful in many contexts, but particularly in resolving the repetive elements common to many genomes.</p>
<p>Though you should know long before you touch the terminal what kind of sequencing data you will recieve, naming conventions take the guesswork out of identifying PE reads. Navigate to <code>raw_reads/</code> within <code>~/bioe-591-genomics/course-materials/data/</code>, pick a species, and look at the data within its own named subdirectory. You should see files in the following format: A binomial, a sample ID number, and a string reading <code>R1_001</code> or <code>R2_001</code> before the suffix. (In addition to <code>*.fastq.gz</code>, you’ll see files ending in <code>.md5</code>. These contain “checksum” values to verify the integrity of the data with their prefix; we will not concern ourselves with them further in this class, I hope.)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Conirostrum_albifrons_163719_R1_001.fastq.gz</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Conirostrum_albifrons_163719_R1_001.fastq.gz.md5</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Conirostrum_albifrons_163719_R2_001.fastq.gz</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Conirostrum_albifrons_163719_R2_001.fastq.gz.md5</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Intuitively, <code>*R1_001.fastq.gz</code> contains the forward reads for a given sample, while<code>*R2_001.fastq.gz</code> contain the reverse reads. Within each file, reads are in the same order, i.e.&nbsp;correspond to sequences of the same DNA fragment from opposite directions. Let’s look at the first read in each direction from a single sample:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">zcat</span> Conirostrum_albifrons_163719_R1_001.fastq.gz <span class="kw">|</span> <span class="fu">head</span> <span class="at">-n</span> 4</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">@J00138:88:HG7TGBBXX:3:1101:4229:1086</span> 1:N:0:NATGGAAC+NGAACTGT</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">NAATGGGAAGTGTAGGGATACTCCTGACAACTAGATAAGAATCCTTCTTCACCTAAATATAAACGCTTTTCCTCAACCTCTGTGATCAGAAGAGTGGAAGAAACCCAACCATAGCACATCCAGAAACACTCTTGGCCAGGACACAGCAGAT</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#AAAFJJFJJJJFJJJJJJJJJJJJJJJJJJJJJJJJJJJJJJJJJJFJJJJJFJJJJJJJJJJJJJJJJJJJJJJJJJJJJJFFJJJJJJJJJFFFJJFJJJJJJJJJJFJJJJJJJJJJJJJJJJJJFJJJJJJJJJJAJJJFFJJFAJ</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">zcat</span> Conirostrum_albifrons_163719_R2_001.fastq.gz <span class="kw">|</span> <span class="fu">head</span> <span class="at">-n</span> 4</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">@J00138:88:HG7TGBBXX:3:1101:4229:1086</span> 2:N:0:NATGGAAC+NGAACTGT</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">NTTATGCTTTAAGTCAGAAAAGGGCCAGTCAGCAGGAAAACATGCTACTTGCTTGGGGAAAGGATTGTGGATGTGGCAGAGCAAGGGAAGAGGTGCCCAACCATCAGCAGCATCTGTTGGTCTGAGAGGGTGGGAGATGGTGGGGTTCCTC</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#AAFAAF7J&lt;FFJFFFJJFFFJJJJJJJJJJJJFJJJFFFFJJJFJJJJFJAAAFFJJJJJJJJ--&lt;AJJF7FFJ&lt;7AJJJJJJJAJJFJFFFFJJJFFFFJJFFJJFJJJF-&lt;-&lt;-&lt;AFAA&lt;FAFFJJJJJJJ-F&lt;-7&lt;-7&lt;)-)-)-&lt;&lt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>You should note two things. First, the headers are identical other than the number before <code>:N</code> following the space in the first line, which corresponds to read 1 (<code>1:N</code>) or read 2 (<code>2:N</code>). This is what we would expect, as PE reads come from the exact same flowcell, lane, and position on the sequencer. Second, it should be clear that the sequences are different—recall that “same fragment” does not mean “same genomic location”, and reads are shorter than the DNA they are generated from.</p>
</section>
<section id="filtering-reads-with-fastp" class="level2">
<h2 class="anchored" data-anchor-id="filtering-reads-with-fastp">Filtering Reads with <code>fastp</code></h2>
<p>We will now learn the basics of the traditional first step of preparing sequence data for analysis: trimming adapter sequences and filtering reads based on quality and levels of missing data. Recall from your reading last class that preparing genomic libraries typically involves appending adapter sequences to each sample. These contain <a href="https://en.wikipedia.org/wiki/Oligonucleotide">oligonucleotides</a> used in sequencing reactions, as well as unique indices that permit data to be disambiguated (i.e., matched to known samples). Though relatively short, including adapter sequences in downstream processing steps could cause numerous errors, and thus must be removed prior to alignment. Additionally, low but pervasive sequencing errors will result in variable quality among reads. Ensuring reliable data necessarily involves filtering out reads with the highest likelihood of errors.</p>
<p>To achieve these goals, we will use a clever, simple tool called <code>fastp</code>. Please briefly read or skim <a href="https://github.com/OpenGene/fastp">the documentation here before continuing.</a> before proceeding. Some of it will likely be above your head, but you will hopefully recognize a simple command-line syntax from using <code>seqtk</code> the week prior: the name of the program, the name of a particular task it performs, and parameters.</p>
<p>As with last week and the weeks to come, we will begin by setting up a <code>mamba</code> environment for <code>fastp</code>. If it’s your first time logging on today, you’ll need to load the <code>mamba</code> module and make it callable:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load Mamba/23.11.0-0<span class="kw">;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="st">"</span><span class="va">$(</span><span class="ex">conda</span> shell.bash hook<span class="va">)</span><span class="st">"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Next, create a file called <code>fastp.yaml</code> somewhere in your personal directory. The contents should be as follows:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">name:</span> fastp</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">channels:</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> conda-forge</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> bioconda</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">dependencies:</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> fastp</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Create a new environment with the command <code>mamba env create -f fastp.yaml</code>. Activate the environment, and type <code>fastp</code>. You should see a suite of commands matching those in the documentation. Discussing how to a highly informed decision about which parameter settings to use is beyond our purview (and realistically beyond the purview of most <code>fastp</code> users). Luckily, the program’s default parameters are sensible for the majority of cases: it automatically detects and removes commonly used adapters, trims error-prone bases from both ends until a quality threshhold is reached, ditches reads below 15 bp in length (from super-short DNA fragments), ditches reads where 40% or more bases are low quality, and trims repetitive sequences from ends (if present). Quality filtering is based on <strong>Phred scores</strong>, which are a transformation of error probabilities at each base:</p>
<p><span class="math display">\[
Q = -10log_{10}(P_{error})
\]</span></p>
<p>In other words, a Phred score of 10 (typically reported as Q10) means there is a 1 in 10 probability of error; Q20, a 1/100 probability; Q30, a 1/1000 probablity. But where does the probability of error come from?, I can hear you asking. The answer is numerous aspects of the sequencing process itself, such as fluorescence intensity and the overlap of different “signals” for nucleotides. For now, the important thing is that filtering by Phred scores gives you control over the error you are willing to tolerate in your data.</p>
<p>Other <code>fastp</code> parameters include paths for input files, output files, and reports. Very few of these need to be set explicitly, as we will see when we use the tool shortly. To do so, we will again need to schedule a job via <code>Slurm</code>. Copy the file <code>~/bioe-591-genomics/course-materials/scripts/fastp.sbatch</code> to your own directory. It should look like this:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">## example-array.slurm.sh: submit an array of jobs with a varying parameter</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">## Lines starting with #SBATCH are read by Slurm. Lines starting with ## are comments.</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">## All other lines are read by the shell.</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --account=priority-bioe-591-genomics        #specify the account to use</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=fastp                             # job name</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --partition=priority              # queue partition to run the job in</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --nodes=1                       # number of nodes to allocate</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --ntasks-per-node=1             # number of descrete tasks - keep at one except for MPI</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=1              # number of cores to allocate</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=0-00:30:00                 # Maximum job run time</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=fastp_demo-%j.out</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=fastp_demo-%j.err</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co"># load module and activate mamba</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load Mamba/23.11.0-0</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="st">"</span><span class="va">$(</span><span class="ex">conda</span> shell.bash hook<span class="va">)</span><span class="st">"</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># activate your fastp environment</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate fastp</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co"># run fastp</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="ex">fastp</span> <span class="at">-i</span> ~/bioe-591-genomics/course-materials/data/raw_reads/species/species_ID_R1_001.fastq.gz <span class="dt">\</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>-o ~/bioe-591-genomics/students/username/trimmed_reads/species_ID_R1_001_trimmed.fastq.gz <span class="dt">\</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>-I ~~/bioe-591-genomics/course-materials/data/raw_reads/species/species_ID_R2_001.fastq.gz <span class="dt">\</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>-O ~/bioe-591-genomics/students/username/trimmed_reads/species_ID_R2_001_trimmed.fastq.gz <span class="dt">\</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>-h ~/bioe-591-genomics/students/username/trimmed_reads/sample.fastp.html <span class="dt">\</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>-j ~/bioe-591-genomics/students/username/trimmed_reads/sample.fastp.json</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Four flags indicate necessary arguments, all of which will appear at the top of <code>fastp's</code> usage info:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">options:</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-i,</span> <span class="at">--in1</span>                            read1 input file name <span class="er">(</span><span class="ex">string</span> <span class="pp">[</span><span class="ss">=</span><span class="pp">]</span><span class="kw">)</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-o,</span> <span class="at">--out1</span>                           read1 output file name <span class="er">(</span><span class="ex">string</span> <span class="pp">[</span><span class="ss">=</span><span class="pp">]</span><span class="kw">)</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-I,</span> <span class="at">--in2</span>                            read2 input file name <span class="er">(</span><span class="ex">string</span> <span class="pp">[</span><span class="ss">=</span><span class="pp">]</span><span class="kw">)</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-O,</span> <span class="at">--out2</span>                           read2 output file name <span class="er">(</span><span class="ex">string</span> <span class="pp">[</span><span class="ss">=</span><span class="pp">]</span><span class="kw">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Here, either the short version (<code>-</code>) or long version (<code>--</code>) of the argument flag will work; <code>string [=]</code> simply means characters (your path) are accepted. Note that the demo script includes input paths to specific species in <code>course-materials/data/raw_reads</code>, but output paths to a new subdirectory called <code>trimmed_reads</code> in your personal directory. Make this, and edit the other paths so that they point to real files for your tanager species of choice. Pay particular attention to the read direction—it’s easy to end up with both input or output files labeled <code>R1_001</code> if you aren’t careful. From the subdirectory with your copy of this now-editing <code>.sbatch</code> script, run it via the usual command (<code>sbatch fastp.sbatch</code>). Recall that you can monitor its progress via <code>sacct</code> and related commands, and that standard output and error messages are logged in <code>.out</code> and <code>.err</code> files that appear in your working directory.</p>
<p>The program should finish running on most data within a few minutes. Navigate to the path you set for the .html report (<code>-h</code>). This file is an extremely useful summary of what <code>.fastp</code> did and discovered in your data; it can be viewed in any web browser after transferring it to your laptop with Globus. (Today’s homework will address its contents in greater detail.) Navigate also to your <code>trimmed_reads</code> directory and confirm it contains the expected files. If so, congratulations—you’ve completed the first step of a typical bioinformatics pipeline for one sample.</p>
<div class="callout callout-style-default callout-note callout-titled" title="**Homework 4**">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span><strong>Homework 4</strong>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Today’s homework assignment has four components:</p>
<ol type="1">
<li>The main goal is to write an <code>sbatch</code> script that will run <code>fastp</code> on all samples of your focal species and summarize the output. (I realize this will involve re-trimming one sample; overwriting the files you generated above is fine.) You may do so anyway you see fit, so long as the script is robust and achieves that goal. However, you will likely use one of the following three approaches.</li>
</ol>
<ul>
<li>Copy and paste your <code>fastp</code> command as many times as necessary, editing paths as necessary.</li>
<li>Use <code>fastp</code>’s <a href="https://github.com/OpenGene/fastp?tab=readme-ov-file#batch-processing">built-in “batch processing” script</a>.</li>
<li>Write a bash script that runs your <code>fastp</code> command on each file in a repository (or list of files). Using online resources to do so is fine, but I request that you add a comment to each line of code explaining what it is doing. Here is one possibility, though note that as written it will only <code>echo</code> the commands it generates, not run them:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r1 <span class="kw">in</span> data/<span class="pp">*</span>_R1<span class="pp">*</span>.fastq.gz<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">r2</span><span class="op">=</span><span class="st">"</span><span class="va">${r1</span><span class="op">/</span><span class="ss">_R1</span><span class="op">/</span>_R2<span class="va">}</span><span class="st">"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">sample</span><span class="op">=</span><span class="va">$(</span><span class="fu">basename</span> <span class="st">"</span><span class="va">$r1</span><span class="st">"</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">'s/_R1.*//'</span><span class="va">)</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">"fastp -i </span><span class="dt">\"</span><span class="va">$r1</span><span class="dt">\"</span><span class="st"> -I </span><span class="dt">\"</span><span class="va">$r2</span><span class="dt">\"</span><span class="st"> </span><span class="dt">\</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="st">  -o clean/</span><span class="va">${sample}</span><span class="st">_R1.clean.fastq.gz -O clean/</span><span class="va">${sample}</span><span class="st">_R2.clean.fastq.gz </span><span class="dt">\</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="st">  -h reports/</span><span class="va">${sample}</span><span class="st">.fastp.html -j reports/</span><span class="va">${sample}</span><span class="st">.fastp.json"</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ol start="2" type="1">
<li><p>Once you have written your <code>sbatch</code> script, push it to your GitHub repository as <code>04_homework_&lt;your_name&gt;.sh</code>. Next, transfer the <code>fastp.html</code> report from the cluster to your computer, and rename it in the format <code>04_fastp_&lt;your_name&gt;.html</code>. Push this to GitHub as well.</p></li>
<li><p>Open <code>04_fastp_&lt;your_name&gt;.html</code> in your web browser. In a separate Markdown file named <code>04_interpretation_&lt;your_name&gt;.md</code>, answer the following brief questions:</p></li>
</ol>
<ul>
<li>What percentage of reads passed filtering?</li>
<li>What percentage of reads were low quality?</li>
<li>What is the estimated insert size, and what percentage of your reads is it based on?</li>
<li>At approximately what read position does mean quality drop below Q30 on read2 after filtering? How does this differ from the position at which mean quality drops below Q30 on read2 <em>before</em> filtering?</li>
</ul>
<ol start="4" type="1">
<li>Assess the structure of your GitHub repository, organize as needed, and edit your <code>README.md</code> to explain what files and directories contain and where to find them. You now have <code>.sbatch</code> scripts, an <code>.html</code> document, and a <code>.md</code> file with answers to the questions above. These could be arranged in subdirectories, corresponding to the week they were assigned, separated into <code>scripts/</code>, <code>markdown/</code> and <code>reports/</code> subdirectories, or sorted in some other way. What you do is up to you, but make sure it is clear and well documented. (And don’t forget to add, commit, and push your changes!)</li>
</ol>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>